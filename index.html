<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Indomitus: Tower of Abyss · Text Roguelite (SPA)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111723; --ink:#e7eef8; --muted:#93a6bf; --accent:#7fb3ff; --good:#4ad69d; --bad:#ff6b6b; --amber:#ffcc66;
      --radius:18px; --shadow:0 12px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--ink); background:radial-gradient(1200px 900px at 80% -20%, #1a2331 0%, transparent 70%), var(--bg)}
    header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(8px); background:linear-gradient(180deg, rgba(12,16,22,.85), rgba(12,16,22,.6)); border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1020px; margin:0 auto; padding:14px 18px}
    nav{display:flex; align-items:center; gap:10px}
    .brand{font-weight:800; letter-spacing:.2px; margin-right:auto}
    a.pill{display:inline-flex; align-items:center; gap:.5rem; text-decoration:none; color:var(--ink); border:1px solid rgba(255,255,255,.08); padding:8px 14px; border-radius:999px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03)); transition:transform .12s ease, border-color .2s ease}
    a.pill[aria-current="page"], a.pill:hover{border-color:rgba(255,255,255,.22)}

    main{min-height:calc(100vh - 68px)}
    .route{display:none; animation:fade .22s ease both}
    .route.active{display:block}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow); padding:22px; margin-block:18px}
    h1{font-size:clamp(26px,4vw,38px); margin:6px 0}
    h2{font-size:clamp(20px,2.6vw,26px); margin:10px 0}
    p.lead{color:var(--muted); max-width:75ch}

    .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr))}

    .ui{display:grid; gap:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{cursor:pointer; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); color:var(--ink); padding:10px 14px; border-radius:12px; font-weight:600}
    .btn:hover{border-color:rgba(255,255,255,.25)}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border-radius:999px; background:#0f1623; border:1px solid rgba(255,255,255,.08); color:var(--muted); font-size:14px}

    .log{background:#0c131e; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; min-height:240px; max-height:440px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .log p{margin:.45rem 0}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .amber{color:var(--amber)}

    footer{color:#97a6bb; font-size:13px; padding:30px 18px; text-align:center; opacity:.85}

    @keyframes fade{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <nav>
        <div class="brand">⚔️ Indomitus: Tower of Abyss (Text Roguelite)</div>
        <a class="pill" href="#/" data-link>Home</a>
        <a class="pill" href="#/game" data-link>Game</a>
        <a class="pill" href="#/hub" data-link>Angel's Watch</a>
        <a class="pill" href="#/codex" data-link>Codex</a>
      </nav>
    </div>
  </header>

  <main class="wrap" id="app" tabindex="-1">
    <!-- Home -->
    <section class="route" data-route="/">
      <div class="card">
        <h1>Indomitus Crusade: Tower of Abyss</h1>
        <p class="lead">Prologue — You are part of a vast Imperial host waging the Indomitus Crusade on the world of <strong>Sigra</strong>. The forces of Chaos have raised a black spire, the <strong>Tower of Abyss</strong>. You are chosen to enter, strike at its heart, and return to <strong>Angel's Watch</strong>—an Imperial stronghold—to resupply. Descend to <strong>Floor 10</strong>, defeat each guardian, and end the threat.</p>
        <p><a class="pill" href="#/game">▶ New Run</a></p>
      </div>
      <div class="grid">
        <div class="card"><h2>How to play</h2><p>Pick a class and chapter/order/regiment, then push room by room. Encounters are combat, tests, or brief rests. Each combat round has a chance for a random twist (1 in 6). Medkits are rare but fully heal. Armor reduces damage <em>and</em> raises AC. Kill foes to earn XP and Thrones (₮), scaled by floor. Return to Angel's Watch to shop. Level cap is 40; every 5 levels, gain +1 to a random stat.</p></div>
        <div class="card"><h2>Dice</h2><p>Attacks: <code>d20 + POW + 2</code> vs DEF; crit on 20. Damage scales with <strong>Power</strong>. <strong>Will</strong> boosts Pray healing. <strong>Armor</strong> reduces incoming damage and increases AC.</p></div>
      </div>
    </section>

    <!-- Game -->
    <section class="route" data-route="/game">
      <div class="card">
        <h1>New Run</h1>
        <div class="ui" id="newRun">
          <div class="row">
            <label>Class:
              <select id="arch">
                <option value="marine">Space Marine</option>
                <option value="sister">Sister of Battle</option>
                <option value="guard">Imperial Guardsman</option>
              </select>
            </label>
            <label>Chapter / Order / Regiment:
              <select id="sub"></select>
            </label>
            <label>Difficulty:
              <select id="diff">
                <option value="normal">Normal</option>
                <option value="hard">Hard</option>
              </select>
            </label>
            <label>Seed: <input id="seed" placeholder="(optional)" /></label>
            <button class="btn" id="startBtn">Start</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Status</h2>
          <div class="row">
            <span class="chip">HP: <strong id="hp">-</strong></span>
            <span class="chip">Armor: <strong id="armor">-</strong></span>
            <span class="chip">Will: <strong id="will">-</strong></span>
            <span class="chip">Power: <strong id="pow">-</strong></span>
            <span class="chip">Medkits: <strong id="kits">-</strong></span>
            <span class="chip">Grenades: <strong id="nades">-</strong></span>
            <span class="chip">Floor: <strong id="floor">1</strong></span>
            <span class="chip">Room: <strong id="room">1/10</strong></span>
            <span class="chip">Lvl: <strong id="lvl">1</strong></span>
            <span class="chip">XP: <strong id="xp">0</strong></span>
            <span class="chip">₮: <strong id="money">0</strong></span>
            <span class="chip">Best Floor: <strong id="best">0</strong></span>
            <button class="btn" id="goHubBtn" style="margin-left:auto">Return to Angel's Watch</button>
          </div>
        </div>
        <div class="card">
          <h2>Encounter</h2>
          <div class="log" id="log" aria-live="polite"></div>
          <div class="row" id="actions"></div>
        </div>
      </div>
    </section>

    <!-- Hub / Shop -->
    <section class="route" data-route="/hub">
      <div class="card">
        <h1>Angel's Watch – Rogue Trader</h1>
        <p class="lead">Spend Thrones to prepare for the next descent into the Tower of Abyss.</p>
        <div class="row">
          <span class="chip">Your ₮: <strong id="hubMoney">0</strong></span>
          <span class="chip">Medkits: <strong id="hubKits">0</strong></span>
          <span class="chip">Grenades: <strong id="hubNades">0</strong></span>
          <span class="chip">Lvl: <strong id="hubLvl">1</strong></span>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <h2>Supplies</h2>
          <div class="row">
            <button class="btn" id="buyKit">Buy Medkit (₮30)</button>
            <button class="btn" id="buyNade">Buy Grenade (₮20)</button>
            <button class="btn" id="buyArmor">Buy Plating (+1 Armor, ₮60)</button>
            <button class="btn" id="buyPower">Augmetics (+1 Power, ₮70)</button>
            <button class="btn" id="buyWill">Rosarius (+1 Will, ₮70)</button>
          </div>
        </div>
        <div class="card">
          <h2>Depart</h2>
          <p>Resume your run at the next room you had reached.</p>
          <button class="btn" id="departBtn">Back to the Tower</button>
        </div>
      </div>
    </section>

    <!-- Codex -->
    <section class="route" data-route="/codex">
      <div class="card">
        <h1>Codex</h1>
        <p class="lead">Classes, subfactions, and starting stats</p>
        <ul>
          <li><strong>Space Marine</strong> — HP 35, Armor 2, Will 2, Power 2. Chapters: <em>Imperial Fists</em> (+2 Armor), <em>Blood Angels</em> (+2 Power), <em>Ultramarines</em> (+1 Will, +10 HP).</li>
          <li><strong>Sister of Battle</strong> — HP 30, Armor 1, Will 3, Power 2. Orders: <em>Argent Shroud</em> (+2 Will), <em>Our Martyred Lady</em> (+1 Will, +1 Armor), <em>Ebon Chalice</em> (+1 Power, +5 HP).</li>
          <li><strong>Imperial Guardsman</strong> — HP 25, Armor 1, Will 2, Power 2. Regiments: <em>Cadian</em> (+1 Armor, +1 Power), <em>Catachan</em> (+2 Power), <em>Kriegsman</em> (+1 Will, +10 HP).</li>
        </ul>
        <p>Attacks: <code>d20 + POW + 2</code> vs DEF (crit on 20). Damage scales with <strong>Power</strong>. <strong>Armor</strong> reduces incoming damage and raises your AC. <strong>Will</strong> increases Pray healing. Boss on every Floor 10; final foe is the Chaos Lord.</p>
      </div>
    </section>

    <!-- 404 -->
    <section class="route" data-route="/404">
      <div class="card"><h1>Not found</h1><p class="lead">Try Home, Game, or Angel's Watch.</p></div>
    </section>
  </main>

  <footer>Built with ❤️ using just HTML, CSS, and JavaScript. Fan-made prototype inspired by a grimdark setting.</footer>

  <script>
  'use strict';
  // ----------------- Router -----------------
  const routes = Array.from(document.querySelectorAll('.route'));
  const navLinks = Array.from(document.querySelectorAll('a[data-link]'));
  const app = document.getElementById('app');
  function setActiveLink(route){ navLinks.forEach(a=>{ const target=new URL(a.href).hash.slice(1)||'/'; a.setAttribute('aria-current', target===route?'page':'false'); }); }
  function showRoute(route){ let found=false; routes.forEach(el=>{ const match=el.dataset.route===route; el.classList.toggle('active',match); if(match) found=true; }); if(!found){ route='/404'; routes.forEach(el=>el.classList.toggle('active', el.dataset.route===route)); } setActiveLink(route); app.focus({preventScroll:true}); if(route==='/game'){ UI.syncStats(); UI.setBest(Store.best()); } if(route==='/hub'){ Hub.sync(); } }
  function getHash(){ const raw=location.hash.slice(1); return raw&&raw.startsWith('/')?raw:'/'; }
  addEventListener('hashchange',()=>showRoute(getHash())); addEventListener('load',()=>{ initNewRunUI(); showRoute(getHash()); });

  // ----------------- Utilities -----------------
  const RNG = (()=>{ let s = 0x2F6E2B1; function seed(x){ s = x>>>0 || (Math.random()*1e9)|0; } function next(){ s ^= s << 13; s ^= s >>> 17; s ^= s << 5; return (s>>>0)/4294967296; } function rollDie(sides){ return (next()*sides|0)+1; } function roll(expr){ const m = /^(\d+)d(\d+)([+-]\d+)?$/.exec(expr.trim()); if(!m) return 0; const n=+m[1], d=+m[2], k=m[3]?+m[3]:0; let t=0; for(let i=0;i<n;i++) t+=rollDie(d); return t+k; } return { seed, next, rollDie, roll };})();
  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  function pick(arr){ return arr[(RNG.next()*arr.length)|0]; }
  function hashString(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; } return h; }

  // ----------------- Data -----------------
  const ARCHETYPES = {
    marine:{ name:'Space Marine', base:{ hp:35, armor:2, will:2, pow:2, kits:1, nades:0 } },
    sister:{ name:'Sister of Battle', base:{ hp:30, armor:1, will:3, pow:2, kits:2, nades:0 } },
    guard:{ name:'Imperial Guardsman', base:{ hp:25, armor:1, will:2, pow:2, kits:1, nades:1 } },
  };
  const SUBFACTIONS = {
    marine:[
      { id:'fists', name:'Imperial Fists', bonus:{ armor:+2 } },
      { id:'blood', name:'Blood Angels', bonus:{ pow:+2 } },
      { id:'ultra', name:'Ultramarines', bonus:{ will:+1, hp:+10 } },
    ],
    sister:[
      { id:'argent', name:'Order of the Argent Shroud', bonus:{ will:+2 } },
      { id:'martyred', name:'Order of Our Martyred Lady', bonus:{ will:+1, armor:+1 } },
      { id:'ebon', name:'Order of the Ebon Chalice', bonus:{ pow:+1, hp:+5 } },
    ],
    guard:[
      { id:'cadian', name:'Cadian', bonus:{ armor:+1, pow:+1 } },
      { id:'catachan', name:'Catachan', bonus:{ pow:+2 } },
      { id:'krieg', name:'Kriegsman', bonus:{ will:+1, hp:+10 } },
    ]
  };
  const ENEMIES = [
    { id:'cultist', name:'Heretic Cultist', hp:14, atk:3, def:10, dmg:'1d6+1' },
    { id:'ork', name:'Ork Boy', hp:22, atk:4, def:11, dmg:'1d8' },
    { id:'stealer', name:'Genestealer', hp:18, atk:6, def:12, dmg:'1d6+2', crit:19 },
    { id:'tr8r', name:'Traitor Astartes', hp:28, atk:6, def:12, dmg:'1d8+2' },
  ];
  const BOSSES = [
    { id:'champ', name:'Chaos Champion', hp:36, atk:7, def:13, dmg:'1d8+3' },
    { id:'tyranid', name:'Tyranid Warrior', hp:34, atk:7, def:13, dmg:'1d10+1' },
  ];
  const CHAOS_LORD = { id:'lord', name:'Chaos Lord', hp:80, atk:9, def:18, dmg:'1d10+4', crit:18 };

  // ----------------- Store (best floor) -----------------
  const Store = {
    key:'grimRogue_scores_v3',
    read(){ try{return JSON.parse(localStorage.getItem(this.key))||{best:0,runs:0};}catch{return {best:0,runs:0};} },
    write(v){ localStorage.setItem(this.key, JSON.stringify(v)); },
    best(){ return this.read().best||0; },
    setBest(n){ const d=this.read(); d.best=Math.max(d.best||0,n); this.write(d); },
    addRun(){ const d=this.read(); d.runs=(d.runs||0)+1; this.write(d); }
  };

  // ----------------- UI Helpers -----------------
  const UI = (()=>{ const hp=gid('hp'), armor=gid('armor'), kits=gid('kits'), nades=gid('nades'); const room=gid('room'), floor=gid('floor'), log=gid('log'), actions=gid('actions'); const best=gid('best'), will=gid('will'), pow=gid('pow'), lvl=gid('lvl'), xp=gid('xp'), money=gid('money');
    function clearActions(){ actions.innerHTML=''; }
    function addAction(label, on){ const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.addEventListener('click', on); actions.appendChild(b); return b; }
    function write(html){ const p=document.createElement('p'); p.innerHTML=html; log.appendChild(p); log.scrollTop=log.scrollHeight; }
    function resetLog(){ log.innerHTML=''; }
    function syncStats(){ if(!Game.s) return; const s=Game.s; hp.textContent=`${s.hp}/${s.maxHp}`; armor.textContent=s.armor; kits.textContent=s.kits; nades.textContent=s.nades; floor.textContent=s.floor; room.textContent=`${s.room}/10`; will.textContent=s.will; pow.textContent=s.pow; lvl.textContent=s.lvl; xp.textContent=`${s.exp}/${xpToNext(s.lvl)}`; money.textContent=s.money; }
    function setBest(n){ best.textContent=n; }
    return { clearActions, addAction, write, resetLog, syncStats, setBest };
  })();
  function gid(id){ return document.getElementById(id); }

  // ----------------- Game Core -----------------
  const Game = {
    s:null,
    start(archKey, subId, diff, seed){
      RNG.seed(seed? hashString(seed): 0);
      const base = JSON.parse(JSON.stringify(ARCHETYPES[archKey].base));
      const sub = SUBFACTIONS[archKey].find(x=>x.id===subId) || SUBFACTIONS[archKey][0];
      applyBonus(base, sub.bonus);
      this.s = { name:ARCHETYPES[archKey].name, sub:sub.name, diff,
        maxHp:base.hp, hp:base.hp, armor:base.armor, will:base.will, pow:base.pow,
        kits:base.kits, nades:base.nades, floor:1, room:1, dead:false,
        exp:0, lvl:1, money:0, shardsDestroyed:0, shardsKept:0 };
      UI.resetLog();
      UI.write(`<span class="amber">You are a ${this.s.name} of the ${this.s.sub}. Mission: breach the Tower of Abyss.</span>`);
      UI.syncStats();
      this.nextEncounter();
    },
    nextEncounter(){
      const s=this.s; if(s.dead) return;
      UI.clearActions();
      if(s.room===10){
        const bossTpl = (s.floor===10? CHAOS_LORD : pick(BOSSES));
        const boss = scaleEnemy(bossTpl, s.floor, true);
        combatStart([boss], true);
        return;
      }
      const r = RNG.next();
      if(r<0.55){
        const foes = (s.floor>=3)? [scaleEnemy(pick(ENEMIES), s.floor), scaleEnemy(pick(ENEMIES), s.floor)] : [scaleEnemy(pick(ENEMIES), s.floor)];
        combatStart(foes, false);
      } else if(r<0.83){
        skillEvent();
      } else {
        campfire();
      }
    },
    advanceRoom(){ const s=this.s; if(s.dead) return; s.room = Math.min(10, s.room+1); UI.syncStats(); this.nextEncounter(); },
    advanceFloor(){ const s=this.s; if(s.dead) return; const cleared=s.floor; s.floor += 1; s.room = 1; UI.write(`<strong class='good'>Floor ${cleared} cleared. Descending to Floor ${s.floor}.</strong>`); Store.setBest(Math.max(Store.best(), cleared)); UI.syncStats(); this.nextEncounter(); },
    die(){ const s=this.s; if(!s || s.dead) return; s.dead=true; Store.setBest(Math.max(Store.best(), s.floor-1)); Store.addRun(); UI.clearActions(); UI.write(`<span class="bad">You fall on Floor ${s.floor}, Room ${s.room}. The run ends.</span>`); UI.addAction('New Run', ()=>location.hash = '#/game'); UI.setBest(Store.best()); },
    finishWithEnding(){
      const s=this.s; if(!s || s.dead) return; s.dead=true; Store.setBest(Math.max(Store.best(), 10));
      const d=s.shardsDestroyed; let title='', text='';
      if(d===10){ title='Purity Ending'; text='All ten shards destroyed. The tower collapses and you are hailed as a hero, a legend remembered forever.'; }
      else if(d>=6){ title='Good Ending'; text='Most shards destroyed. You save the world, but at the cost of your own life—an unsung hero whose sacrifice sealed victory.'; }
      else if(d===5){ title='Neutral Ending'; text='Exactly half destroyed. You are deemed tainted yet not lost; exiled on a penance crusade to seek redemption.'; }
      else if(d>=1){ title='Bad Ending'; text='Too many shards kept. Deemed corrupted and detained—never seen again, remembered as a traitor to Sigra.'; }
      else { title='Traitor Ending'; text='No shards destroyed. You abandon your oath and join the Long War under the banner of Chaos.'; }
      UI.write(`<strong class="amber">${title}</strong> — ${text}`);
      UI.clearActions(); UI.addAction('New Run', ()=>location.hash='#/game'); UI.setBest(Store.best());
    }
  };

  function applyBonus(base, bonus){ for(const k in bonus){ base[k] = (base[k]||0) + bonus[k]; } }
  function scaleEnemy(tpl, floor, isBoss=false){
    const e=JSON.parse(JSON.stringify(tpl));
    let mult=1+0.12*(floor-1);
    if(floor>=7) mult*=1.25;
    if(isBoss) mult*=1.1;
    if(isBoss && floor===10) mult*=1.4; // Chaos Lord
    e.hp = Math.round(e.hp*mult);
    e.atk = e.atk + Math.floor((floor-1)/3);
    e.def = e.def + Math.floor((floor-1)/3);
    e.stunned=false; e.defending=false; e.armorBuffTurns=0; e.dmgBuff=0;
    return e;
  }

  // ---------- Combat (supports 1 or 2 foes) ----------
  function combatStart(foeList, boss=false){
    const foes = foeList.map(f=>JSON.parse(JSON.stringify(f)));
    const s = Game.s;
    UI.write(`<strong>${boss? 'BOSS: ':''}${foes.map(f=>f.name).join(' & ')}</strong> appear${foes.length>1?'':'s'}.`);
    const state = { playerSkip:false, emperorChoice:false };

    function living(){ return foes.filter(f=>f.hp>0); }

    const turn = () => {
      if(RNG.rollDie(6)===1){ randomCombatEvent(state, foes); if(s.dead) return; if(state.emperorChoice){ presentEmperorChoice(); return; } }
      if(state.playerSkip){ state.playerSkip=false; return enemyPhase(); }

      UI.clearActions();
      // Targeted attacks
      for(const [i,f] of living().entries()){
        UI.addAction(`Shoot (${f.name})`, ()=> playerAttack('shoot', i));
        UI.addAction(`Strike (${f.name})`, ()=> playerAttack('melee', i));
      }
      if(s.nades>0) UI.addAction('Grenade (blast)', ()=>{
        s.nades--;
        const raw = RNG.roll('2d6') + Math.floor(s.pow/2);
        for(const f of living()){
          let real = raw - Math.floor(f.def/6);
          if(f.defending) real = Math.floor(real*0.6);
          f.hp -= Math.max(0, real);
        }
        UI.write(`<span class="good">Grenade explodes (${raw} raw) across the line.</span>`);
        postPlayer();
      });
      if(s.kits>0) UI.addAction('Medkit (full heal)', ()=>{ s.kits--; s.hp = s.maxHp; UI.write(`<span class="good">You fully heal.</span>`); UI.syncStats(); enemyPhase(); });
      UI.addAction('Pray (Will)', ()=>{ const heal = RNG.roll('1d6') + 2 + s.will; s.hp = clamp(s.hp + heal, 0, s.maxHp); UI.write(`<span class="good">Faith restores ${heal} HP.</span>`); UI.syncStats(); enemyPhase(); });
      UI.addAction("Retreat to Angel's Watch", ()=>{ location.hash = '#/hub'; });
    };

    function playerAttack(kind, idx){
      const f = living()[idx]; if(!f) return;
      const tag = kind==='shoot'? 'bolt fire':'blade';
      const d20a = RNG.rollDie(20); const d20b = RNG.rollDie(20);
      const roll = d20a; // keep simple: no advantage except from events handled separately
      const mod = s.pow + 2;
      const total = roll + mod;
      if(roll===20){ let dmg= RNG.roll('1d8+2') + s.pow; if(f.defending) dmg=Math.floor(dmg*0.6); f.hp-=dmg; UI.write(`<span class='good'>CRIT! Your ${tag} deals ${dmg}. ${f.name} HP ${Math.max(f.hp,0)}</span>`); }
      else if(roll===1){ UI.write(`<span class='bad'>Fumble—your ${tag} misses.</span>`); }
      else if(total>=f.def){ let dmg= RNG.roll('1d8+1') + s.pow; if(f.defending) dmg=Math.floor(dmg*0.6); f.hp-=dmg; UI.write(`<span class='good'>Hit for ${dmg}. ${f.name} HP ${Math.max(f.hp,0)}</span>`); }
      else { UI.write(`Miss (rolled ${roll}+${mod} vs DEF ${f.def}).`); }
      postPlayer();
    }

    function postPlayer(){
      for(const f of foes){ if(f.defending) f.defending=false; } // ends after they tank
      // any kills -> rewards immediately
      for(const f of foes){
        if(f.hp<=0 && !f._rewarded){
          const rewards = onKillRewards(Game.s.floor, boss);
          s.exp += rewards.xp; s.money += rewards.credits; f._rewarded=true;
          UI.write(`<span class='good'>${f.name} falls. +${rewards.xp} XP, +₮${rewards.credits}.</span>`);
          levelCheck(); UI.syncStats(); loot();
        }
      }
      if(living().length===0){
        if(boss){ handleBossShard(); } else { Game.advanceRoom(); }
      } else {
        enemyPhase();
      }
    }

    function enemyPhase(){
      if(s.dead) return;
      const target = 10 + s.armor + (s.diff==='hard'?1:0);
      for(const f of living()){
        if(f.stunned){ UI.write(`<span class='amber'>${f.name} is stunned and loses the turn.</span>`); f.stunned=false; continue; }

        if(Game.s.floor>=6){
          const act = RNG.next();
          if(f.hp <= Math.max(10, Math.floor(f.hp*0.5)) && act<0.35){
            const heal = RNG.rollDie(6)+4; f.hp += heal; UI.write(`<span class='bad'>${f.name} knits vile flesh (+${heal} HP).</span>`); continue;
          } else if(act<0.55){
            f.defending = true; UI.write(`<span class='amber'>${f.name} braces to deflect blows (reduced damage until next act).</span>`); continue;
          }
        }

        const r = RNG.rollDie(20); const bonus = f.atk; const total=r+bonus;
        if(f.crit && r>=f.crit){ let dmg = RNG.roll(f.dmg)*2 + (f.dmgBuff||0); dmg = Math.max(0, dmg - s.armor); s.hp -= dmg; f.dmgBuff=0; UI.write(`<span class='bad'>${f.name} CRITS for ${dmg} after armor!</span>`); }
        else if(total>=target){ let dmg = RNG.roll(f.dmg) + (f.dmgBuff||0); dmg = Math.max(0, dmg - s.armor); s.hp -= dmg; f.dmgBuff=0; UI.write(`<span class='bad'>${f.name} hits for ${dmg} (rolled ${r}+${bonus} vs AC ${target}).</span>`); }
        else { UI.write(`${f.name} misses (rolled ${r}+${bonus}).`); }
        if(s.hp<=0){ UI.syncStats(); Game.die(); return; }
      }
      UI.syncStats();
      turn();
    }

    function presentEmperorChoice(){
      UI.clearActions();
      UI.write(`<span class="good">You hear the Voice of the Emperor. A boon is offered.</span>`);
      UI.addAction('Heal (5–10)', ()=>{ const heal = RNG.rollDie(6)+4; s.hp = clamp(s.hp+heal,0,s.maxHp); UI.write(`<span class="good">Sanctified vigor restores ${heal} HP.</span>`); UI.syncStats(); state.emperorChoice=false; turn(); });
      UI.addAction('Full Heal', ()=>{ s.hp = s.maxHp; UI.write(`<span class="good">Grace floods your veins. Full health restored.</span>`); UI.syncStats(); state.emperorChoice=false; turn(); });
      UI.addAction('Smite (instant kill)', ()=>{ const live = living(); if(live.length){ const tgt = pick(live); tgt.hp=0; UI.write(`<strong class="good">Holy light un-makes ${tgt.name}!</strong>`); } state.emperorChoice=false; postPlayer(); });
    }

    turn();
  }

  function randomCombatEvent(state, foes){
    const s=Game.s; const live = foes.filter(f=>f.hp>0); const foe = live.length? pick(live):null;
    const which = RNG.rollDie(7);
    if(which===1 && foe){ const heal = RNG.rollDie(10); foe.hp += heal; UI.write(`<span class="amber">Warp mends ${foe.name}: +${heal} HP.</span>`); }
    else if(which===2 && foe){ const buff = RNG.rollDie(3); foe.def += buff; foe.armorBuffTurns=2; UI.write(`<span class="amber">Warp hardens ${foe.name}: +${buff} DEF for a short while.</span>`); }
    else if(which===3 && foe){ const buff = 5 + (RNG.rollDie(6)-1); foe.dmgBuff = buff; UI.write(`<span class="amber">Warp fury surges: ${foe.name} will deal +${buff} damage on their next hit.</span>`); }
    else if(which===4){ state.playerSkip=true; if(foe) foe.stunned=true; UI.write(`<span class="amber">Warp shock stuns both sides—your next action and ${foe?foe.name:"the foe"}'s next turn are lost.</span>`); }
    else if(which===5){ state.playerSkip=true; UI.write(`<span class="bad">Warp backlash—<strong>you are stunned</strong> and lose your next action.</span>`); }
    else if(which===6 && foe){ foe.stunned=true; UI.write(`<span class="good">${foe.name} reels—stunned.</span>`); }
    else { state.emperorChoice=true; UI.write(`<span class="good">A golden whisper: “Stand, warrior.”</span>`); }
    UI.syncStats();
  }

  function handleBossShard(){
    const s=Game.s;
    UI.write(`<span class="amber">A <strong>Chaos Shard</strong> clatters to the ground.</span>`);
    UI.clearActions();
    UI.addAction('Destroy the shard', ()=>{
      s.shardsDestroyed++; UI.write(`<span class="good">You crush it to ash. (${s.shardsDestroyed}/10 destroyed)</span>`);
      if(s.floor>=10){ Game.finishWithEnding(); } else { Game.advanceFloor(); }
    });
    UI.addAction('Keep the shard', ()=>{
      s.shardsKept++; UI.write(`<span class="bad">You pocket the shard. Its whisper lingers. (${s.shardsKept} kept)</span>`);
      if(s.floor>=10){ Game.finishWithEnding(); } else { Game.advanceFloor(); }
    });
  }

  function onKillRewards(floor, boss){ const xp = (boss? 20: 6) + floor*2; const credits = (boss? 30: 5) + floor*3; return { xp, credits }; }
  function xpToNext(lvl){ return 20 + (lvl-1)*10; }
  function levelCheck(){
    const s=Game.s;
    while(s.exp >= xpToNext(s.lvl) && s.lvl < 40){
      s.exp -= xpToNext(s.lvl);
      s.lvl++;
      UI.write(`<span class='good'>Level up! You are now level ${s.lvl}.</span>`);
      if(s.lvl%5===0){ const stat = pick(['will','pow','armor']); s[stat]++; UI.write(`<span class='good'>Milestone bonus: +1 ${stat.toUpperCase()}.</span>`); }
    }
  }

  // ---------- Events & Rest ----------
  function skillEvent(){
    const s=Game.s; const events=[
      {name:'Sealed Bulkhead', skill:'pow', dc:12, ok:'You smash the lock; salvage a grenade.', fail:'Alarm blares; you take 3 damage rushing.', effect:(ok)=>{ if(ok) s.nades++; else s.hp-=3; }},
      {name:'Rally the Scattered', skill:'will', dc:12, ok:'Your words steel hearts (+6 HP).', fail:'Doubt gnaws (-2 HP).', effect:(ok)=>{ s.hp=clamp(s.hp+(ok?6:-2),0,s.maxHp); }},
      {name:'Silent Sentry', skill:'pow', dc:12, ok:'You drop the sentry from cover (+₮10).', fail:'Spotted! (-3 HP).', effect:(ok)=>{ if(ok) s.money+=10; else s.hp-=3; }},
      {name:'Close Quarters Drill', skill:'pow', dc:12, ok:'Decisive strike (+1 Armor this run).', fail:'Overextend (-3 HP).', effect:(ok)=>{ if(ok) s.armor++; else s.hp-=3; }},
      // New optional events
      {name:'Relic Shrine', skill:'will', dc:12, ok:'Rite intoned (+1 WILL).', fail:'Doubt creeps in (-1 WILL).', effect:(ok)=>{ s.will += ok?1:-1; }},
      {name:'Booby-Trapped Cache', skill:'pow', dc:13, ok:'You disarm the charge and claim supplies (+1 medkit).', fail:'Trap pops—lose a grenade and -3 HP.', effect:(ok)=>{ if(ok){ s.kits++; } else { if(s.nades>0) s.nades--; s.hp-=3; } }},
      {name:'Marksman’s Roost', skill:'pow', dc:13, ok:'Hours of drilling (+1 POW).', fail:'Scope bite (-1 POW).', effect:(ok)=>{ s.pow += ok?1:-1; }},
    ];
    const ev = pick(events);
    UI.write(`<em>${ev.name}</em> — test your <strong>${ev.skill.toUpperCase()}</strong> (DC ${ev.dc}) or ignore.`);
    UI.clearActions();
    UI.addAction('Attempt', ()=>{
      const ro = skillCheck(ev.skill, ev.dc);
      if(ro.crit){ UI.write(`<span class='good'>Critical success (rolled 20)! ${ev.ok}</span>`); ev.effect(true); }
      else if(ro.ok){ UI.write(`<span class='good'>Success (roll ${ro.roll}+${ro.mod} ≥ ${ro.dc}). ${ev.ok}</span>`); ev.effect(true); }
      else if(ro.fumble){ UI.write(`<span class='bad'>Fumble (rolled 1). ${ev.fail} You also drop a grenade if you have one.</span>`); ev.effect(false); if(s.nades>0) s.nades--; }
      else { UI.write(`<span class='bad'>Fail (roll ${ro.roll}+${ro.mod} < ${ro.dc}). ${ev.fail}</span>`); ev.effect(false); }
      UI.syncStats();
      UI.clearActions(); UI.addAction('Onward', ()=>Game.advanceRoom());
    });
    UI.addAction('Ignore', ()=>{ UI.write('You pass it by.'); Game.advanceRoom(); });
  }

  function campfire(){
    const s=Game.s; UI.write('A brief lull in the fighting.'); UI.clearActions();
    UI.addAction('Rest (+6 HP)', ()=>{ s.hp = clamp(s.hp+6,0,s.maxHp); UI.write('<span class="good">You patch wounds and reload.</span>'); UI.syncStats(); Game.advanceRoom(); });
    UI.addAction('Scavenge (d20)', ()=>{ const r = RNG.rollDie(20); if(r>=18){ s.kits++; UI.write('<span class="good">You find a rare medkit.</span>'); } else if(r>=12){ s.nades++; UI.write('<span class="good">You find a grenade.</span>'); } else if(r>=8){ s.money+=10; UI.write('<span class="good">You loot ₮10.</span>'); } else { UI.write('Nothing useful.'); } UI.syncStats(); Game.advanceRoom(); });
    UI.addAction("Return to Angel's Watch", ()=>{ location.hash = '#/hub'; });
  }

  // ---------- Mechanics ----------
  function skillCheck(stat, dc){ const s=Game.s; const roll=RNG.rollDie(20); const mod=(stat==='will'?s.will:s.pow); const total=roll+mod; return { ok:total>=dc && roll!==1, crit:roll===20, fumble:roll===1, roll, mod, dc }; }
  function loot(){ const s=Game.s; const r=RNG.next(); if(r<0.15){ s.kits++; UI.write('You recover a (rare) medkit.'); } else if(r<0.5){ s.nades++; UI.write('You salvage a grenade.'); } else { s.hp=clamp(s.hp+4,0,s.maxHp); UI.write('You catch your breath (+4 HP).'); } UI.syncStats(); }

  // ----------------- Hub (Shop) -----------------
  const Hub = {
    money:gid('hubMoney'), kits:gid('hubKits'), nades:gid('hubNades'), lvl:gid('hubLvl'),
    sync(){ if(!Game.s) return; const s=Game.s; this.money.textContent=s.money; this.kits.textContent=s.kits; this.nades.textContent=s.nades; this.lvl.textContent=s.lvl; },
    buy(cost, fn){ const s=Game.s; if(s.money>=cost){ s.money-=cost; fn(); UI.write(`<span class='good'>Purchased for ₮${cost}.</span>`); this.sync(); UI.syncStats(); } }
  };
  gid('buyKit').addEventListener('click', ()=>Hub.buy(30, ()=>Game.s.kits++));
  gid('buyNade').addEventListener('click', ()=>Hub.buy(20, ()=>Game.s.nades++));
  gid('buyArmor').addEventListener('click', ()=>Hub.buy(60, ()=>Game.s.armor++));
  gid('buyPower').addEventListener('click', ()=>Hub.buy(70, ()=>Game.s.pow++));
  gid('buyWill').addEventListener('click', ()=>Hub.buy(70, ()=>Game.s.will++));
  gid('departBtn').addEventListener('click', ()=>{ location.hash = '#/game'; Game.nextEncounter(); });

  // ----------------- New Run controls -----------------
  function initNewRunUI(){
    const arch = gid('arch'); const sub = gid('sub');
    function fillSub(){ const key = arch.value; sub.innerHTML=''; for(const s of SUBFACTIONS[key]){ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sub.appendChild(o); } }
    arch.addEventListener('change', fillSub); fillSub();
    gid('startBtn').addEventListener('click', ()=>{ const seed = gid('seed').value.trim(); Game.start(arch.value, sub.value, gid('diff').value, seed); });
    gid('goHubBtn').addEventListener('click', ()=>{ location.hash = '#/hub'; });
  }
  </script>
</body>
</html>
